        <!DOCTYPE HTML>
        <html>
        <head>
        <title>Hack The Box Writeups</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <link rel="stylesheet" href="assets/css/main.css" />
        <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
        </head>
        <body class="is-preload">

        <!-- Wrapper -->
        <div id="wrapper">

        <!-- Header -->
        <header id="header">
       
                <img src="https://res-1.cloudinary.com/crunchbase-production/image/upload/c_lpad,f_auto,q_auto:eco/u0bfxlfxnv9iv3haotgd" alt="" width="200" height="200">
        <div class="content">
                <div class="inner">
                        <h1>Hack The Box Writeups</h1>
                        <p>Usman Q. Khan</p>
                </div>
        </div>
        <nav>
                <ul>
                        <li><a href="/index.html">Home</a></li>
                        <li><a href="#servmon">Servmon</a></li>
                        <li><a href="#sauna">Sauna</a></li>
                       <!-- <li><a href="#traceback">Traceback</a></li>
                        <li><a href="#admirer">Admirer</a></li>
                        <li><a href="#blunder">Blunder</a></li>
                        <li><a href="#cache">Cache</a></li>
                        <li><a href="#magic">Magic</a></li> -->
                </ul>
        </nav>
        </header>

        <!-- Main -->
        <div id="main">

        <!-- Intro -->
        <article id="servmon">
        <h2 class="major">Servmon</h2>
        <span class="image main"><img src="https://i.ytimg.com/vi/Oe_q2LHqAqA/hqdefault.jpg" alt="" /></span>
        <p>The Servmon box is a windows machine rated as an easy box. It was also the first box I ever rooted on the Hack The Box platform.</p>
        <p><h3>Enumeration</h3></p>
        <p>So first we start with an <code>nmap</code> scan</p>
        <span class="image main"><p><img src="/images/servmon/servmon1.png" alt="" width="550"/></p></span>
        <p>We can see that there are a good amount of ports open, but what caught my eye first was FTP on port 21 and it allowed anonymous login.</p>
        <span class="image main"><p><img src="/images/servmon/servmon2.png" alt="" /></p></span>
        <p>If we anonymously log in to FTP, we can see that there is a Users directory that contains two files: <code>Confidential.txt</code> and <code>Notes to do.txt</code></p>       
        <span class="image main"><p><img src="/images/servmon/servmon3.png" alt="" width="550"/></p></span>
        <p><h3>Foothold</h3></p>
        <p>At this point, I had to do some thinking to figure out what these clues were trying to tell me. I knew that there was a <code>Passwords.txt</code> file on Nathan's Desktop. I also saw that there were two services being used by the users, NVMS and NSClient. My <code>nmap</code> scan had revealed port 80 as open and when I checked it out in my browser, it showed a login page for NVMS-1000. After doing some research for vulnerabilities, I found that NVMS was vulnerable to a <a href="https://www.exploit-db.com/exploits/47774" target="_blank" >Directory Traversal attack.</a></p>        
        <span class="image main"><p><img src="/images/servmon/servmon6.png" alt="" width="550"/></p>     </span>   
        <p>I used Burp Suite to intercept the request and I added the suspected path of the <code>Passwords.txt</code> file to the GET request, resulting in a web page that showed a list of passwords.</p>
        <span class="image main"><p><img src="/images/servmon/servmon7.png" alt="" width="550"/></p></span>
        <p><h3>User</h3></p>       
        <p>After a bit of bruteforcing, I was able to login to SSH as Nadine using the credentials <code>Nadine:L1k3B1gBut7s@W0rk</code>. A tool that can assist with bruteforcing smb shares if you have a list of users or passwords is <a href="https://github.com/byt3bl33d3r/CrackMapExec" target="_blank" >CrackMapExec.</a></p>        
        <span class="image main"><p><img src="/images/servmon/servmon8.png" alt="" /></p>      </span>  
        <p>For privilege escalation, I knew I wanted to start looking into NSClient++ since it was the other third-party service besides NVMS installed on this machine and was something I had never heard of before. By visiting the NSClient++ web GUI on port 8443, we see that there is a way to figure out the password.</p>        
        <span class="image main"><p><img src="/images/servmon/servmon10.png" alt="" width="550"/></p>   </span>      
        <p>By running the command within the Program Files, we're able to grab the password.</p>         
        <span class="image main"><p><img src="/images/servmon/servmon11.png" alt="" /></p>       </span>
        <p>However, my excitement of finding the password died down when it wouldn't work. After some more enumeration, I found the NSClient configuration files called <code>nsclient.ini</code> which gave away very important information.</p>        
        <span class="image main"><p><img src="/images/servmon/servmon12.png" alt="" /></p> </span>       
        <p>It showed that only localhost is allowed to sign in to the web GUI, which meant that I had to somehow trick NSClient into thinking that I am localhost. After a lot of digging, banging my head against the wall, and some nudges on the forums, I learned a neat trick known as <a href="https://www.ssh.com/ssh/tunneling/example" target="_blank" >SSH local port-forwarding.</a></p>         
        <p>By using the command <code>ssh -L 8443:127.0.0.1:8443 Nadine@10.10.10.184</code> we can SSH as Nadine and act as if we are localhost, which allows us to login to the NSClient++ web server.</p>   
        <p><h3>Root</h3></p>        
        <p>After logging in, I found an <a href="https://www.exploit-db.com/exploits/46802" target="_blank" >exploit</a> for NSClient++ which essentially discovered that low privilege users can get remote code execution by running scripts through the NSClient scheduled scripts module. Also, since NSClient runs as root, we are able to execute code as root as well and get a reverse shell as root.</p>        
        <span class="image main"><p><img src="/images/servmon/servmon18.png" alt="" width="550"/></p>  </span>      
        <p>By transferring my <code>shell.bat</code> file as well as netcat to Nadine's machine, we can then execute the script using the NSClient++ web GUI.</p>
        <span class="image main"><p><img src="/images/servmon/servmon19.png" alt="" width="550"/></p></span>
        <p>By adding our script in the external scripts module, we can get NSClient to run it. As soon as I added the script, I reloaded the server under the control menu on the top-right corner. We can then run our script and get a root shell on the box.</p>        
        <span class="image main"><p><img src="/images/servmon/servmon22.png" alt="" width="550"/></p></span>  
        
        </article>

        <!-- Work -->
        <article id="sauna">
        <h2 class="major">Sauna</h2>
        <span class="image main"><img src="/images/sauna/sauna0.png" alt="" /></span>
        <p>Sauna is rated as an easy Windows box that involves exploiting a Kerberos misconfiguration to get the hash of a user account. From there we're able to enumerate and find the credentials for a service account in a registry and we can use that to lateral into a higher privileged account. In order to get root, we use mimikatz functions to dump hashes for the Administrator and log in as the Administrator to grab the root flag.</p>
        <p><h3>Enumeration</h3></p>
        <span class="image main"><p><img src="/images/sauna/sauna1.png" alt="" width="550"/></p></span>
        <p>Our <code>nmap</code> scan reveals a bunch of ports open. The main ports that stood out to me were HTTP on port 80, Kerberos on port 88, and the ports that LDAP was on.</p>
        <p>If we enumerate the webpage, we can see that there is a page with a bunch of employees of the company.</p>
        <span class="image main"><p><img src="/images/sauna/sauna2.png" alt="" width="550"/></p></span>
        <p>Most of the time in a corporate environment, Active Directory usernames consist of the first letter of the first name followed by the last name. So, we can create a list of usernames using that same rule.</p>
        <span class="image main"><p><img src="/images/sauna/sauna13.png" alt="" /></p></span>
        <p><h3>Foothold</h3></p>
        <p>Since we know there is Kerberos on the machine, we can try to find any vulnerable user accounts on the machine that do not require Kerberos preauthentication. Using the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py" target="_blank" >GetNPUsers.py</a> script by <a href="https://github.com/SecureAuthCorp/impacket" target="_blank" >impacket</a> can give us this information and also output any available password hashes. <a href="https://www.youtube.com/watch?time_continue=434&v=pZSyGRjHNO4&feature=emb_logo" target="_blank" >This</a> video explains the script in detail and helped me understand how it works.</p>
        <p>We can run the script against the list of users that we made earlier.</p>
        <p><code>python3 GetNPUsers.py EGOTISTICAL-BANK.LOCAL\ -usersfile users.txt -dc-ip 10.10.10.175</code></p>
        <p>The command below provides us with the hash for the <code>fsmith</code> user and gives us an outfile of the hash.</p>
        <span class="image main"><p><img src="/images/sauna/sauna3.png" alt="" width="550" /></p></span>
        <p>We can then use John to crack the hash.</p>
        <span class="image main"><p><img src="/images/sauna/sauna4.png" alt="" width="550" /></p></span>
        <p><h3>User</h3></p>
        <p>The creds for the user are <code>fsmith:Thestrokes23</code>.</p>
        <p>Since there isn't SSH on the box, we can use <a href="https://github.com/Hackplayers/evil-winrm" target="_blank" >Evil-WinRM</a> with the creds we just got to get a proper shell.</p>
        <span class="image main"><p><img src="/images/sauna/sauna5.png" alt="" width="550"/></p></span>
        <p>Once we log in, we can grab the user flag.</p>
        <p><h3>Root</h3></p>
        <p>For privilege escalation, we can upload an enumeration script to see if it reveals any attack vectors.</p>
        <span class="image main"><p><img src="/images/sauna/sauna7_.png" alt="" width="550"/></p></span>
        <p>We can upload <a href="https://github.com/absolomb/WindowsEnum" target="_blank" >WindowsEnum.ps1</a> and see if it provides us with anything interesting.</p>
        <p>If we run the script, we're able to get creds for a service account on the box.</p>
        <span class="image main"><p><img src="/images/sauna/sauna8.png" alt="" width="550"/></p></span>
        <p>We can then try logging in to the service account since usually they have higher privileges.</p>
        <span class="image main"><p><img src="/images/sauna/sauna9.png" alt="" width="550"/></p></span>
        <p>Another tool that is helpful in exploiting Kerberos is <a href="https://github.com/gentilkiwi/mimikatz" target="_blank" >mimikatz.</a></p>
        <span class="image main"><p><img src="/images/sauna/sauna10.png" alt="" width="550"/></p></span>
        <p>Mimikatz is a pretty neat tool that has a lot of different features so it can take some time to get used to it and understand the different commands. It took me a while to figure out what the commands do and I tested a lot of them out to figure out what would be best for this box. One of the commands on mimikatz is known as <code>lsadump</code> which essentially dumps anything in the Local Security Authority (LSA) registry. LSA secrets can contain lots of privileged information, and <a href="https://ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets" target="_blank" >this</a> article explains a bit more about the topic.
        <p>In order to dump any credentials for the Administrator account, we can run an <code>lsadump</code> for the Administrator user.</p>
        <span class="image main"><p><img src="/images/sauna/sauna11.png" alt="" width="550"/></p></span>
        <p>We can see that we're able to get the NTLM hash for the Administrator, and we can use it to get a privileged shell on the box.</p>
        <span class="image main"><p><img src="/images/sauna/sauna12.png" alt="" width="550"/></p></span>
        <p>The cool thing about Evil-WinRM is that you can log into an account using a hash, so there's no need to spend time trying to crack it. Once we log in as the Administrator, we can grab the root flag.</p>
        <p>Overall, I really enjoyed this box and I learned a lot about various Kerberos attack vectors and the tools you can use to exploit a Domain Controller. One thing I learned after some research is that the GetNPUsers.py script isn't really something that can be useful in a real-world engagement. Most admins dont check off the "Do not require Kerberos preauthentication" option when configuring Active Directory policies so it's a very rare attack vector.</p>
        <p>Another key thing which is more of a practical aspect related to exploiting Windows is that while I was trying to get accustomed to mimikatz, sometimes the prompt would infinetly loop and I would have to end my shell in order for it to stop. To get around that, I learned that you can just add the commands you want in quotes and then add the "exit" command to end mimikatz as soon as you get what you're looking for.</p>
</article>

        <!-- Work -->
        <article id="traceback">
        <h2 class="major">Traceback</h2>
        <span class="image main"><img src="https://miro.medium.com/max/1188/1*J9oQgkmo45Ov4k2Kk7bL-A.png" alt="" /></span>
        <p>The writeup will be available once the machine retires.</p>
        </article>

        <!-- About -->
        <article id="admirer">
        <h2 class="major">Admirer</h2>
        <span class="image main"><img src="https://atsika.info/images/htb-admirer/overview.png" alt="" /></span>
        <p>The writeup will be available once the machine retires.</p>
        </article>

        <!-- Contact -->
        <article id="blunder">
        <h2 class="major">Blunder</h2>
         <span class="image main"><img src="https://lukashku.com/content/images/2020/06/blunder.png" alt="" /></span>
        <p>The writeup will be available once the machine retires.</p>
        </article>

        <!-- Elements -->
        <article id="cache">
        <h2 class="major">Cache</h2>
        <span class="image main"><img src="/images/cache.jpg" alt="" /></span>
        <p>The writeup will be available once the machine retires.</p>
         </article>
                
         <article id="magic">
        <h2 class="major">Magic</h2>
        <span class="image main"><img src="/images/magic.png" alt="" /></span>
        <p>The writeup will be available once the machine retires.</p>
      </article>

  </div>

</div>

<!-- BG -->
<div id="bg"></div>

<!-- Scripts -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script type="text/javascript" src="https://platform.linkedin.com/badges/js/profile.js" async defer></script>

</body>
</html>
